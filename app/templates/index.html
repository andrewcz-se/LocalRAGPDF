<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local RAG Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .context-box { 
            background-color: #f8f9fa; 
            border-left: 4px solid #0d6efd; 
            font-family: monospace; 
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .inspector-box {
            background-color: #2c3e50;
            color: #ecf0f1;
            font-family: monospace; 
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 5px;
        }
        .stats-badge { font-size: 0.9rem; margin-right: 5px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">Local PDF RAG Assistant</span>
    </div>
</nav>

<div class="container">
    
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-chat-tab" data-bs-toggle="pill" data-bs-target="#pills-chat" type="button" role="tab">Chat & Search</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-inspect-tab" data-bs-toggle="pill" data-bs-target="#pills-inspect" type="button" role="tab">Database Inspector</button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        
        <!-- CHAT TAB -->
        <div class="tab-pane fade show active" id="pills-chat" role="tabpanel">
            <!-- Stats Row -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card p-3">
                        <h5 class="card-title">Database Statistics</h5>
                        <div>
                            <span class="badge bg-success stats-badge">Files: {{ files|length }}</span>
                            <span class="badge bg-info stats-badge">Total Chunks: {{ chunk_count }}</span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Ingested Files:</small><br>
                            {% for f in files %}
                                <span class="badge bg-secondary me-1">{{ f }}</span>
                            {% else %}
                                <span class="text-muted fst-italic">No files ingested yet.</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Query Row -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3 h-100">
                        <label for="queryInput" class="form-label fw-bold">Ask a Question</label>
                        <textarea class="form-control mb-3" id="queryInput" rows="4" placeholder="e.g., What is a Puma?"></textarea>
                        <button class="btn btn-primary w-100" onclick="sendQuery()" id="askBtn">
                            Ask AI
                        </button>
                        <div id="loader" class="text-center mt-3 d-none">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="small text-muted mt-1">Thinking...</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <!-- Answer -->
                    <div class="card p-3">
                        <h5 class="card-title text-primary">AI Answer</h5>
                        <div id="answerOutput" class="fs-7 text-dark">
                            <em class="text-muted">Answer will appear here...</em>
                        </div>
                    </div>

                    <!-- Sources -->
                    <div class="card p-3">
                        <h6 class="card-title fw-bold">Sources Used</h6>
                        <div id="sourcesOutput">
                            <small class="text-muted">-</small>
                        </div>
                    </div>

                    <!-- Context (Raw Data) -->
                    <div class="card p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title fw-bold m-0">Retrieved Context (Raw)</h6>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#contextCollapse">
                                Toggle View
                            </button>
                        </div>
                        <div class="collapse show" id="contextCollapse">
                            <div id="contextOutput" class="p-3 context-box">Raw context text will appear here...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INSPECTOR TAB -->
        <div class="tab-pane fade" id="pills-inspect" role="tabpanel">
            <div class="card p-4">
                <h4 class="mb-3">Database Inspector</h4>
                <div class="row g-3 align-items-center mb-4">
                    <div class="col-auto">
                        <label class="col-form-label">Select File:</label>
                    </div>
                    <div class="col-auto">
                        <select class="form-select" id="inspectFileSelect">
                            <option value="all">-- All Files --</option>
                            {% for f in files %}
                                <option value="{{ f }}">{{ f }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="col-form-label">Limit:</label>
                    </div>
                    <div class="col-auto">
                        <select class="form-select" id="inspectLimit">
                            <option value="5">5 Chunks</option>
                            <option value="20" selected>20 Chunks</option>
                            <option value="50">50 Chunks</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-warning" onclick="inspectDB()">Fetch Chunks</button>
                    </div>
                </div>

                <div id="inspectorOutput" class="inspector-box">
                    <em class="text-white">Select a file and click "Fetch Chunks" to inspect raw database content.</em>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    async function sendQuery() {
        const query = document.getElementById('queryInput').value;
        if (!query) return;

        document.getElementById('askBtn').disabled = true;
        document.getElementById('loader').classList.remove('d-none');
        document.getElementById('answerOutput').innerHTML = '<em class="text-muted">Generating answer...</em>';

        try {
            const response = await fetch('/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });
            const data = await response.json();

            document.getElementById('answerOutput').innerHTML = marked.parse(data.answer);

            const sourcesDiv = document.getElementById('sourcesOutput');
            sourcesDiv.innerHTML = '';
            if (data.sources && data.sources.length > 0) {
                const ul = document.createElement('ul');
                data.sources.forEach(s => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${s.file}</strong> (Page ${s.page}) - Section: <em>${s.section}</em>`;
                    ul.appendChild(li);
                });
                sourcesDiv.appendChild(ul);
            } else {
                sourcesDiv.innerHTML = '<small class="text-muted">No specific sources found.</small>';
            }

            document.getElementById('contextOutput').innerText = data.context || "No context retrieved.";

        } catch (error) {
            document.getElementById('answerOutput').innerHTML = `<span class="text-danger">Error: ${error.message}</span>`;
        } finally {
            document.getElementById('askBtn').disabled = false;
            document.getElementById('loader').classList.add('d-none');
        }
    }

    async function inspectDB() {
        const filename = document.getElementById('inspectFileSelect').value;
        const limit = document.getElementById('inspectLimit').value;
        const outputDiv = document.getElementById('inspectorOutput');
        
        outputDiv.innerHTML = '<span class="text-info">Fetching data...</span>';

        try {
            const response = await fetch(`/inspect?file=${filename}&limit=${limit}`);
            const data = await response.json();
            
            if (data.length === 0) {
                outputDiv.innerHTML = '<span class="text-warning">No chunks found for this criteria.</span>';
                return;
            }

            let html = '';
            data.forEach((item, index) => {
                html += `
            <div class="mb-3 border-bottom border-secondary pb-3">
                <strong class="text-warning">Chunk #${index + 1}</strong> <span class="text-white">(ID: ${item.id})</span><br>
                <div class="mt-1 mb-1">
                    <span class="badge bg-secondary">File: ${item.metadata.file}</span>
                    <span class="badge bg-info text-dark">Section: ${item.metadata.section}</span>
                    <span class="badge bg-dark border border-secondary">Page: ${item.metadata.page}</span>
                </div>
                <pre class="mt-2" style="white-space: pre-wrap;">${item.content}</pre>
            </div>`;
            });
            
            outputDiv.innerHTML = html;

        } catch (error) {
            outputDiv.innerHTML = `<span class="text-danger">Error fetching data: ${error.message}</span>`;
        }
    }
</script>
</body>
</html>